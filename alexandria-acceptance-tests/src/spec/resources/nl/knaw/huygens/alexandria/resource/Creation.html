<html xmlns:c="http://www.concordion.org/2007/concordion"
      xmlns:h="http://alexandria.huygens.knaw.nl/concordion-extension"
      xmlns:xsi="http://www.w3.org/1999/xhtml"
      xsi:schemaLocation="http://alexandria.huygens.knaw.nl/concordion-extension
                          http://huygensing.github.io/alexandria/xsd/concordion-rest.xsd">

<title>Creating External Resources</title>

<body class="container">

    <h2 class="page-header">Creating external resources</h2>

    <h3>Examples:</h3>

    <div id="create-post" class="panel panel-default">
        <div class="panel-heading"><b>How can I create an external resource without specifying an ID?</b></div>
        <div class="panel-body">
            <h:request>
                When I <h:post>/resources</h:post>
                the following body: <h:jsonBody>{
                    "resource": {
                    "ref": "http://www.example.com/titles/path/to/title/resource"
                    }
                } </h:jsonBody>
                then I should receive <h:status>201 Created</h:status> and the response contains
                a Location header starting with <h:location type="base">https://{host}/resources/</h:location>,
                followed by a <h:location type="uuid">well-formed UUID</h:location>.
                <!-- The location is: <h:location type="full"/>. Cannot predict generated URL -->
                <p>The response body is <h:responseBody/>.</p>
            </h:request>
            </div>
    </div>

    <div id="create-put" class="panel panel-default" c:execute="clearStorage()">
        <div class="panel-heading"><b>How can I create an external resource with a specific UUID?</b></div>
        <div class="panel-body">
            <h:request>
                When I <h:put>/resources/6e56c868-c0a9-11e4-a762-cb9a664afc01</h:put>
                the following body: <h:jsonBody> {
                    "resource": {
                        "id": "6e56c868-c0a9-11e4-a762-cb9a664afc01",
                        "ref": "http://www.example.com/titles/path/to/title/resource",
                        "provenance": {
                            "who": "nederlab",
                            "why": "some reason",
                            "when": "2015-04-07T09:10:55.877Z"
                        }
                    }
                } </h:jsonBody>
                then I should receive <h:status>201 Created</h:status> and the response body is <h:responseBody/>.
            </h:request>

            <h:request>
                Then <h:get>/resources/6e56c868-c0a9-11e4-a762-cb9a664afc01</h:get>
                should return <h:status>200 OK</h:status> with a response body containing
                <h:jsonResponse>{ "resource": {
                    "id" : "6e56c868-c0a9-11e4-a762-cb9a664afc01",
                    "ref": "http://www.example.com/titles/path/to/title/resource",
                    "^provenance": "https://{host}/resources/6e56c868-c0a9-11e4-a762-cb9a664afc01/provenance"
                } }</h:jsonResponse>
            </h:request>

            <h:request>
                And <h:get>/resources/6e56c868-c0a9-11e4-a762-cb9a664afc01/provenance</h:get>
                should return <h:status>200 OK</h:status> with a response body containing
                <h:jsonResponse>{ "provenance": {
                    "who": "nederlab",
                    "why": "some reason",
                    "when": "{date.beforeNow}",
                    "^what": "https://{host}/resources/6e56c868-c0a9-11e4-a762-cb9a664afc01"
                } } </h:jsonResponse>
            </h:request>
        </div>
    </div>

    <div id="post-empty" class="panel panel-default" c:execute="clearStorage()">
        <div class="panel-heading"><b>What happens when I POST an empty body when creating a new resource?</b></div>
        <div class="panel-body">
            <h:request>
                When I <h:post>/resources</h:post> the following body:
                <pre class="json" c:execute="body(#TEXT)"> </pre>
                then I should receive <h:status>400 Bad Request</h:status> and the response body contains:
                <h:jsonResponse>[{"message":"may not be null"}]</h:jsonResponse>
            </h:request>
        </div>

        <!--
        <ul>
            <li>When I <b c:set="#method">POST</b>
                <pre c:execute="body(#TEXT)"></pre>
                to <code c:set="#endpoint"><b>/resources</b></code></li>

            <li c:execute="request(#method, #endpoint)">Then:
                <ol>
                    <li>the response status should be <b c:assertEquals="status()">400 Bad Request</b>;</li>
                    <li>the response body contains (amongst other error details):
                        <h:jsonResponse>[ {
                            "message" : "may not be null",
                            "messageTemplate" : "{javax.validation.constraints.NotNull.message}",
                            "path" : "ResourcesEndpoint.createResource.arg0"
                            }
                            ]
                        </h:jsonResponse>
                    </li>
                </ol>
            </li>
        </ul>
        -->
    </div>

    <div id="post-missing-ref" class="panel panel-default" c:execute="clearStorage()">
        <div class="panel-heading">
            <b>What happens when I POST a body without a <code>ref</code> when creating a new resource?</b></div>
        <div class="panel-body">
            <h:request>
                When I <h:post>/resources</h:post> the following body:
                <h:jsonBody>{
                    "resource": {
                        "provenance" : {
                            "who" : "nederlab",
                            "why" : "some reason",
                            "when" : "2015-04-07T09:10:55.877Z"
                        }
                    }
                }
                </h:jsonBody>
                Then I should receive <h:status>400 Bad Request</h:status>
                and the response body contains:
                <h:jsonResponse>[{"message":"Missing required 'ref' field"}]</h:jsonResponse>
            </h:request>
        </div>
    </div>

    <div id="put-entity-id-must-match-url" class="panel panel-default" c:execute="clearStorage()">
        <div class="panel-heading">
            <b>When creating a new resource via PUT, the id in the entity body MUST match the one used in the URL</b>
        </div>
        <div class="panel-body">
            <h:request>
                When I <h:put>/resources/6e56c868-c0a9-11e4-a762-cb9a664afc01</h:put>
                the following body (note the mismatch for parameter <code>id</code>):
                <h:jsonBody>{
                    "resource": {
                        "id": "3c86e050-f7d8-11e4-9c82-df9a2acb2bd1",
                        "ref": "http://www.example.com/titles/path/to/title/resource"
                    }
                }</h:jsonBody>
                Then I should receive <h:status>400 Bad Request</h:status> and the response body contains:
                <h:jsonResponse>[{"message" : "Entity 'id' must match the one used in the URL"}]</h:jsonResponse>
            </h:request>
        </div>
    </div>

    <!--
    <div c:execute="clear()" class="example">
        <h3>When creating a new resource via PUT, the id in the entity body MUST match the one used in the URL</h3>

        <ul>
            <li>Given some resource located which is to be stored as UUID
                <code>6e56c868-c0a9-11e4-a762-cb9a664afc01</code>
            </li>

            <li>When I <b c:set="#method">PUT</b> (note the mismatch for parameter <code>id</code>)
<pre c:execute="body(#TEXT)">{
    "resource": {
        "id": "3c86e050-f7d8-11e4-9c82-df9a2acb2bd1",
        "ref": "http://www.example.com/titles/path/to/title/resource",
        "createdOn": "2015-04-07T09:10:55.877Z"
    }
}</pre>
                to <code c:set="#endpoint"><b>/resources/6e56c868-c0a9-11e4-a762-cb9a664afc01</b></code>
            </li>

            <li c:execute="request(#method, #endpoint)">Then:
                <ol>
                    <li>the response status should be <b c:assertEquals="status()">400 Bad Request</b>;</li>
                    <li>the response body contains (amongst other error details):
                        <h:jsonResponse>[
                            {
                            "message" : "Entity 'id' must match the one used in the URL"
                            }
                            ]
                        </h:jsonResponse>
                    </li>
                </ol>
            </li>
        </ul>
    </div>
    -->

</body>
</html>

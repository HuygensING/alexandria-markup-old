<html xmlns:c="http://www.concordion.org/2007/concordion"
      xmlns:r="https://alexandria.huygens.knaw.nl"
      xmlns:xsi="http://www.w3.org/1999/xhtml"
      xsi:schemaLocation="https://alexandria.huygens.knaw.nl http://pragmatists.github.io/concordion-rest-extension/xsd/concordion-rest.xsd">

<title>Creating External Resources</title>

<body class="container">

<h2 class="page-header">Creating external resources</h2>

<div class="examples">
    <div c:execute="clear()" class="example">
        <h3>How can I create an external resource without specifying an ID?</h3>

        <r:request>
            When I <r:post>/resources</r:post> the following body:
            <r:jsonBody>
                {
                    "resource": {
                    "ref": "http://www.example.com/titles/path/to/title/resource"
                    }
                }
            </r:jsonBody>
        </r:request>
        then I should receive <r:status>201 Created</r:status> with the following body:
        <r:jsonResponse> {
            "resource": {
                "ref": "http://www.example.com/titles/path/to/title/resource",
                "annotations": [],
                "createdOn": "{date.beforeNow}"
                }
            }
        </r:jsonResponse>

        <ul>
            <li>Given some resource located at <code>http://www.example.com/titles/path/to/title/resource</code></li>

            <li>When I <b c:set="#method">POST</b>
<pre c:execute="body(#TEXT)">{
    "resource": {
        "ref": "http://www.example.com/titles/path/to/title/resource"
    }
}</pre>
                to <code c:set="#endpoint"><b>/resources</b></code></li>

            <li c:execute="request(#method, #endpoint)">Then:
                <ol>
                    <li>the response status should be <b c:assertEquals="status()">201 Created</b>;</li>
                    <li>the response contains the Location header
                        <b c:assertEquals="base()">https://{host}/resources/</b>
                        followed by a <b c:assertEquals="uuidQuality()">well-formed UUID</b>;
                    </li>
                    <li>the response body looks like:
                        <r:jsonResponse> {
                            "resource": {
                            "ref": "http://www.example.com/titles/path/to/title/resource",
                            "annotations": [],
                            "createdOn": "{date.beforeNow}"
                            }
                            }
                        </r:jsonResponse>
                    </li>
                </ol>
            </li>
        </ul>
    </div>

    <div c:execute="clear()" class="example">
        <h3>How can I create an external resource with a specific UUID?</h3>

        <ul>
            <li>Given a resource located at <code>http://www.example.com/titles/path/to/title/resource</code>,
                which is to be stored as UUID <code>6e56c868-c0a9-11e4-a762-cb9a664afc01</code>, and <b>no</b> resource
                with that UUID exists yet
            </li>

            <li>When I <b c:set="#method">PUT</b>
<pre c:execute="body(#TEXT)">{
    "resource": {
        "id": "6e56c868-c0a9-11e4-a762-cb9a664afc01",
        "ref": "http://www.example.com/titles/path/to/title/resource",
        "createdOn": "2015-04-07T09:10:55.877Z"
    }
}</pre>
                to <code c:set="#endpoint"><b>/resources/6e56c868-c0a9-11e4-a762-cb9a664afc01</b></code></li>

            <li c:execute="request(#method, #endpoint)">Then:
                <ol>
                    <li>the response status should be <b c:assertEquals="status()">204 No Content</b>;</li>
                    <li>the response body is <b c:assertEquals="response()">empty</b>.</li>
                </ol>
            </li>
        </ul>
    </div>

    <div c:execute="clear()" class="example">
        <h3>What happens when I POST an empty body when creating a new resource?</h3>

        <ul>
            <li>When I <b c:set="#method">POST</b>
                <pre c:execute="body(#TEXT)"><!-- Intentionally left empty --></pre>
                to <code c:set="#endpoint"><b>/resources</b></code></li>

            <li c:execute="request(#method, #endpoint)">Then:
                <ol>
                    <li>the response status should be <b c:assertEquals="status()">400 Bad Request</b>;</li>
                    <li>the response body contains (amongst other error details):
                        <r:jsonResponse>[ {
                            "message" : "may not be null",
                            "messageTemplate" : "{javax.validation.constraints.NotNull.message}",
                            "path" : "ResourcesEndpoint.createResource.arg0"
                            }
                            ]
                        </r:jsonResponse>
                    </li>
                </ol>
            </li>
        </ul>
    </div>

    <div c:execute="clear()" class="example">
        <h3>What happens when I POST a body without a <code>ref</code> when creating a new resource?</h3>

        <ul>
            <li>When I <b c:set="#method">POST</b>
<pre c:execute="body(#TEXT)">{
    "resource": {
        "annotations": [],
        "createdOn": "2015-04-07T09:10:55.877Z"
    }
}</pre>
                to <code c:set="#endpoint"><b>/resources</b></code></li>

            <li c:execute="request(#method, #endpoint)">Then:
                <ol>
                    <li>the response status should be <b c:assertEquals="status()">400 Bad Request</b>;</li>
                    <li>the response body contains (amongst other error details):
                        <r:jsonResponse>
                            [
                            {
                            "message" : "Missing required 'ref' field"
                            }
                            ]
                        </r:jsonResponse>
                    </li>
                </ol>
            </li>
        </ul>
    </div>

    <div c:execute="clear()" class="example">
        <h3>When creating a new resource via PUT, the id in the entity body MUST match the one used in the URL</h3>

        <ul>
            <li>Given some resource located which is to be stored as UUID
                <code>6e56c868-c0a9-11e4-a762-cb9a664afc01</code>
            </li>

            <li>When I <b c:set="#method">PUT</b> (note the mismatch for parameter <code>id</code>)
<pre c:execute="body(#TEXT)">{
    "resource": {
        "id": "3c86e050-f7d8-11e4-9c82-df9a2acb2bd1",
        "ref": "http://www.example.com/titles/path/to/title/resource",
        "createdOn": "2015-04-07T09:10:55.877Z"
    }
}</pre>
                to <code c:set="#endpoint"><b>/resources/6e56c868-c0a9-11e4-a762-cb9a664afc01</b></code>
            </li>

            <li c:execute="request(#method, #endpoint)">Then:
                <ol>
                    <li>the response status should be <b c:assertEquals="status()">400 Bad Request</b>;</li>
                    <li>the response body contains (amongst other error details):
                        <r:jsonResponse>[
                            {
                            "message" : "Entity 'id' must match the one used in the URL"
                            }
                            ]
                        </r:jsonResponse>
                    </li>
                </ol>
            </li>
        </ul>
    </div>

</div>
</body>
</html>
